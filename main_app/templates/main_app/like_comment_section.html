{% load static %}
<div
  class="engagement-card"
  data-content-type="{{ content_type|default:'news' }}"
  data-object-id="{{ object_id|default:'1' }}"
>
  <div class="engagement-card__header">
    <div class="chip">
      <i class="fas fa-heart"></i>
      Engagement
    </div>
    <span class="text-muted small d-none d-sm-inline">Show support and share your perspective with the community.</span>
  </div>

  <div class="engagement-card__actions">
    {% if user.is_authenticated %}
    <button
      type="button"
      class="btn {% if user_liked %}btn-primary{% else %}btn-outline-primary{% endif %} engagement-like"
      data-liked="{% if user_liked %}true{% else %}false{% endif %}"
    >
      <i class="fas fa-thumbs-up me-2"></i>
      <span class="engagement-like-text">{% if user_liked %}Unlike{% else %}Like{% endif %}</span>
      <span class="engagement-like-count">({{ total_likes|default:'0' }})</span>
    </button>
    {% else %}
    <span class="btn btn-outline-secondary disabled d-inline-flex align-items-center gap-2">
      <i class="fas fa-thumbs-up"></i>
      <span>Like</span>
      <span class="engagement-like-count">({{ total_likes|default:'0' }})</span>
    </span>
    {% endif %}

    <button type="button" class="btn btn-outline-secondary engagement-toggle" data-expanded="true">
      <i class="fas fa-comment me-2"></i>
      <span class="engagement-toggle-text">Hide comments</span>
      <span class="engagement-comment-count">({{ total_comments|default:'0' }})</span>
    </button>
  </div>

  <div class="engagement-card__comments" data-visible="true">
    <div class="engagement-card__form">
      {% if user.is_authenticated %}
      <form
        class="engagement-comment-form"
        data-content-type="{{ content_type|default:'news' }}"
        data-object-id="{{ object_id|default:'1' }}"
      >
        {% csrf_token %}
        <label class="form-label" for="comment-content-{{ object_id|default:'1' }}">Share your thoughts</label>
        <textarea
          id="comment-content-{{ object_id|default:'1' }}"
          class="form-control"
          name="content"
          rows="3"
          placeholder="Write a comment..."
          required
        ></textarea>
        <div class="d-flex gap-2 justify-content-end">
          <button type="submit" class="btn btn-primary btn-sm">
            <i class="fas fa-paper-plane me-1"></i>
            Post comment
          </button>
        </div>
      </form>
      {% else %}
      <div class="alert alert-info mb-0">
        <i class="fas fa-info-circle me-2"></i>
        Please <a href="{% url 'login_page' %}" class="fw-semibold">log in</a> to join the discussion.
      </div>
      {% endif %}
    </div>

    <div class="engagement-card__list comments-list">
      {% for comment in comments %}
        {% include 'main_app/comment_item.html' with comment=comment %}
      {% empty %}
      <div class="engagement-empty">
        <i class="fas fa-comment-slash fa-2x mb-2 d-block"></i>
        <p class="mb-0">No comments yet. Be the first to start the conversation!</p>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const cards = document.querySelectorAll('.engagement-card');
    if (!cards.length) {
      return;
    }

    const fetchOptions = (card) => ({
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': (card.querySelector('input[name=csrfmiddlewaretoken]') || {}).value || '',
      },
      method: 'POST',
    });

    cards.forEach((card) => {
      const contentType = card.dataset.contentType || 'news';
      const objectId = card.dataset.objectId || '1';
      const likeButton = card.querySelector('.engagement-like');
      const toggleButton = card.querySelector('.engagement-toggle');
      const toggleText = card.querySelector('.engagement-toggle-text');
      const commentsWrapper = card.querySelector('.engagement-card__comments');
      const commentForm = card.querySelector('.engagement-comment-form');
      const commentsList = card.querySelector('.engagement-card__list');
      const emptyState = card.querySelector('.engagement-empty');
      const commentCountLabel = card.querySelector('.engagement-comment-count');

      if (likeButton) {
        likeButton.addEventListener('click', () => {
          const csrf = (card.querySelector('input[name=csrfmiddlewaretoken]') || {}).value;
          if (!csrf) {
            return;
          }

          const params = new URLSearchParams();
          params.append('content_type', contentType);
          params.append('object_id', objectId);

          fetch('{% url "toggle_like" %}', {
            ...fetchOptions(card),
            body: params.toString(),
          })
            .then((response) => response.json())
            .then((data) => {
              const likeText = likeButton.querySelector('.engagement-like-text');
              const likeCount = likeButton.querySelector('.engagement-like-count');

              if (data.liked) {
                likeButton.dataset.liked = 'true';
                likeButton.classList.remove('btn-outline-primary');
                likeButton.classList.add('btn-primary');
                if (likeText) {
                  likeText.textContent = 'Unlike';
                }
              } else {
                likeButton.dataset.liked = 'false';
                likeButton.classList.remove('btn-primary');
                likeButton.classList.add('btn-outline-primary');
                if (likeText) {
                  likeText.textContent = 'Like';
                }
              }

              if (likeCount) {
                likeCount.textContent = `(${data.total_likes})`;
              }
            })
            .catch((error) => console.error('Error toggling like:', error));
        });
      }

      if (toggleButton && commentsWrapper && toggleText) {
        toggleButton.addEventListener('click', () => {
          const expanded = toggleButton.dataset.expanded === 'true';
          commentsWrapper.hidden = expanded;
          toggleButton.dataset.expanded = expanded ? 'false' : 'true';
          toggleText.textContent = expanded ? 'Show comments' : 'Hide comments';
        });
      }

      if (commentForm) {
        commentForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const textarea = commentForm.querySelector('textarea');
          const content = textarea ? textarea.value.trim() : '';
          if (!content) {
            return;
          }

          const params = new URLSearchParams();
          params.append('content_type', contentType);
          params.append('object_id', objectId);
          params.append('content', content);

          fetch('{% url "add_comment" %}', {
            ...fetchOptions(card),
            body: params.toString(),
          })
            .then((response) => response.json())
            .then((data) => {
              if (!data.success) {
                return;
              }

              if (textarea) {
                textarea.value = '';
              }

              if (emptyState) {
                emptyState.remove();
              }

              if (commentsList) {
                commentsList.insertAdjacentHTML('afterbegin', data.comment_html);
              }

              if (commentCountLabel) {
                commentCountLabel.textContent = `(${data.total_comments})`;
              }

              if (toggleButton) {
                toggleButton.dataset.expanded = 'true';
                commentsWrapper.hidden = false;
                if (toggleText) {
                  toggleText.textContent = 'Hide comments';
                }
              }
            })
            .catch((error) => console.error('Error posting comment:', error));
        });
      }
    });

    document.addEventListener('click', (event) => {
      const button = event.target.closest('.like-comment');
      if (!button) {
        return;
      }

      const card = button.closest('.engagement-card');
      if (!card) {
        return;
      }

      const commentId = button.dataset.commentId;
      const csrf = (card.querySelector('input[name=csrfmiddlewaretoken]') || {}).value;
      if (!csrf) {
        return;
      }

      const params = new URLSearchParams();
      params.append('comment_id', commentId);

      fetch('{% url "toggle_comment_like" %}', {
        ...fetchOptions(card),
        body: params.toString(),
      })
        .then((response) => response.json())
        .then((data) => {
          const likeLabel = button.querySelector('.comment-thread__action-label');
          const likeCount = button.querySelector('.comment-thread__action-count');

          if (data.liked) {
            button.dataset.liked = 'true';
            button.classList.add('is-liked');
            if (likeLabel) {
              likeLabel.textContent = 'Unlike';
            }
          } else {
            button.dataset.liked = 'false';
            button.classList.remove('is-liked');
            if (likeLabel) {
              likeLabel.textContent = 'Like';
            }
          }

          if (likeCount) {
            likeCount.textContent = data.total_likes;
          }
        })
        .catch((error) => console.error('Error toggling comment like:', error));
    });

    document.addEventListener('click', (event) => {
      const replyButton = event.target.closest('.reply-comment');
      if (replyButton) {
        const card = replyButton.closest('.engagement-card');
        const commentId = replyButton.dataset.commentId;
        const replyForm = card.querySelector(`.reply-form[data-comment-id="${commentId}"]`);

        if (replyForm) {
          card.querySelectorAll('.reply-form').forEach((form) => {
            if (form !== replyForm) {
              form.style.display = 'none';
            }
          });

          replyForm.style.display = 'block';
          const textarea = replyForm.querySelector('textarea');
          if (textarea) {
            textarea.focus();
          }
        }
      }

      const cancelButton = event.target.closest('.cancel-reply');
      if (cancelButton) {
        const replyForm = cancelButton.closest('.reply-form');
        if (replyForm) {
          replyForm.style.display = 'none';
          const textarea = replyForm.querySelector('textarea');
          if (textarea) {
            textarea.value = '';
          }
        }
      }
    });

    document.addEventListener('submit', (event) => {
      const replyForm = event.target.closest('.reply-comment-form');
      if (!replyForm) {
        return;
      }

      event.preventDefault();
      const wrapper = replyForm.closest('.engagement-card');
      const commentContainer = replyForm.closest('.reply-form');
      const textarea = replyForm.querySelector('textarea');
      const content = textarea ? textarea.value.trim() : '';
      const commentId = commentContainer ? commentContainer.dataset.commentId : null;

      if (!content || !commentId || !wrapper) {
        return;
      }

      const params = new URLSearchParams();
      params.append('parent_comment_id', commentId);
      params.append('content', content);

      fetch('{% url "add_reply" %}', {
        ...fetchOptions(wrapper),
        body: params.toString(),
      })
        .then((response) => response.json())
        .then((data) => {
          if (!data.success) {
            return;
          }

          const commentThread = replyForm.closest('.comment-thread');
          let repliesSection = commentThread.querySelector('.comment-thread__children');

          if (repliesSection) {
            repliesSection.insertAdjacentHTML('beforeend', data.reply_html);
          } else {
            commentThread.insertAdjacentHTML(
              'beforeend',
              `<div class="comment-thread__children">${data.reply_html}</div>`
            );
            repliesSection = commentThread.querySelector('.comment-thread__children');
          }

          commentContainer.style.display = 'none';
          if (textarea) {
            textarea.value = '';
          }

          const counter = wrapper.querySelector('.engagement-comment-count');
          if (counter) {
            const match = counter.textContent.match(/\d+/);
            const current = match ? parseInt(match[0], 10) : 0;
            counter.textContent = `(${current + 1})`;
          }
        })
        .catch((error) => {
          console.error('Error submitting reply:', error);
          alert('Sorry, there was an error posting your reply. Please try again.');
        });
    });
  });
</script>
