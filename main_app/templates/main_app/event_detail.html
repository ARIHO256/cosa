{% extends 'main_app/base.html' %}
{% load static %}

{% block title %}{{ event.title }} - COSA Events{% endblock %}

{% block extra_css %}
<style>
    .event-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 60px 0;
        position: relative;
        overflow: hidden;
    }
    .event-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        z-index: 1;
    }
    .event-header .container {
        position: relative;
        z-index: 2;
    }
    .event-meta {
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
    }
    .event-content {
        font-size: 1.1rem;
        line-height: 1.7;
    }
    .event-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        margin-right: 10px;
        margin-bottom: 10px;
    }
    .event-networking { background-color: #e8f5e8; color: #388e3c; }
    .event-workshop { background-color: #fff3e0; color: #f57c00; }
    .event-reunion { background-color: #e3f2fd; color: #1976d2; }
    .event-conference { background-color: #f3e5f5; color: #7b1fa2; }
    .event-social { background-color: #fce4ec; color: #c2185b; }
    .event-webinar { background-color: #e1f5fe; color: #0277bd; }
    
    .status-upcoming { background-color: #e8f5e8; color: #388e3c; }
    .status-ongoing { background-color: #fff3e0; color: #f57c00; }
    .status-completed { background-color: #f5f5f5; color: #666; }
    .status-cancelled { background-color: #ffebee; color: #d32f2f; }
    
    .register-card {
        position: sticky;
        top: 100px;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .organizer-card {
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .back-button {
        position: fixed;
        top: 50%;
        left: 20px;
        transform: translateY(-50%);
        z-index: 1000;
    }
    .countdown-timer {
        background: linear-gradient(45deg, #ff6b6b, #feca57);
        color: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
    }
    .countdown-item {
        display: inline-block;
        margin: 0 10px;
        text-align: center;
    }
    .countdown-number {
        display: block;
        font-size: 2rem;
        font-weight: bold;
    }
    .countdown-label {
        font-size: 0.8rem;
        text-transform: uppercase;
    }
    @media (max-width: 768px) {
        .back-button {
            position: static;
            transform: none;
            margin-bottom: 20px;
        }
        .countdown-number {
            font-size: 1.5rem;
        }
        .countdown-item {
            margin: 0 5px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Back Button -->
<div class="back-button d-none d-lg-block">
    <a href="{% url 'public_events' %}" class="btn btn-primary btn-lg rounded-circle" 
       title="Back to Events" data-bs-toggle="tooltip">
        <i class="fas fa-arrow-left"></i>
    </a>
</div>

<!-- Event Header -->
<div class="event-header" {% if event.featured_image %}style="background-image: url('{{ event.featured_image.url }}'); background-size: cover; background-position: center;"{% endif %}>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <!-- Mobile Back Button -->
                <div class="d-lg-none mb-3">
                    <a href="{% url 'public_events' %}" class="btn btn-outline-light">
                        <i class="fas fa-arrow-left me-2"></i>Back to Events
                    </a>
                </div>
                
                <h1 class="display-5 fw-bold mb-4">{{ event.title }}</h1>
                
                <div class="event-meta">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-2">
                                <i class="fas fa-calendar me-2"></i>
                                <strong>Date:</strong> {{ event.start_date|date:"F d, Y" }}
                                {% if event.end_date and event.end_date != event.start_date %}
                                - {{ event.end_date|date:"F d, Y" }}
                                {% endif %}
                            </div>
                            <div class="mb-2">
                                <i class="fas fa-clock me-2"></i>
                                <strong>Time:</strong> {{ event.start_time|time:"g:i A" }}
                                {% if event.end_time %}
                                - {{ event.end_time|time:"g:i A" }}
                                {% endif %}
                            </div>
                            <div class="mb-2">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                <strong>Location:</strong> {{ event.location }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-2">
                                <i class="fas fa-user me-2"></i>
                                <strong>Organizer:</strong> {{ event.organizer.admin.get_full_name }}
                            </div>
                            {% if event.max_attendees %}
                            <div class="mb-2">
                                <i class="fas fa-users me-2"></i>
                                <strong>Capacity:</strong> {{ event.eventregistration_set.count }}/{{ event.max_attendees }}
                            </div>
                            {% endif %}
                            <div class="mb-2">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Status:</strong> 
                                <span class="event-badge status-{{ event.status }}">{{ event.get_status_display }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container my-5">
    <div class="row">
        <!-- Event Content -->
        <div class="col-lg-8">
            <!-- Event Badges -->
            <div class="mb-4">
                <span class="event-badge event-{{ event.event_type }}">{{ event.get_event_type_display }}</span>
                <span class="event-badge status-{{ event.status }}">{{ event.get_status_display }}</span>
                {% if event.is_free %}
                <span class="event-badge" style="background-color: #e8f5e8; color: #388e3c;">
                    <i class="fas fa-gift me-1"></i>Free
                </span>
                {% endif %}
                {% if event.is_virtual %}
                <span class="event-badge" style="background-color: #e1f5fe; color: #0277bd;">
                    <i class="fas fa-video me-1"></i>Virtual
                </span>
                {% endif %}
            </div>
            
            <!-- Event Description -->
            <div class="event-content">
                <h3 class="mb-3">About This Event</h3>
                <div class="mb-4">
                    {{ event.description|safe }}
                </div>
                
                {% if event.agenda %}
                <h3 class="mb-3">Agenda</h3>
                <div class="mb-4">
                    {{ event.agenda|safe }}
                </div>
                {% endif %}
                
                {% if event.speakers %}
                <h3 class="mb-3">Speakers</h3>
                <div class="mb-4">
                    {{ event.speakers|safe }}
                </div>
                {% endif %}
                
                {% if event.requirements %}
                <h3 class="mb-3">Requirements</h3>
                <div class="mb-4">
                    {{ event.requirements|safe }}
                </div>
                {% endif %}
                
                <!-- Event Tags -->
                {% if event.tags %}
                <h3 class="mb-3">Tags</h3>
                <div class="mb-4">
                    {% for tag in event.tags.all %}
                    <span class="badge bg-secondary me-2 mb-2">{{ tag.name }}</span>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Registration Instructions -->
                {% if event.registration_instructions %}
                <div class="alert alert-info">
                    <h5><i class="fas fa-info-circle me-2"></i>Registration Instructions</h5>
                    {{ event.registration_instructions|safe }}
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Countdown Timer (for upcoming events) -->
            {% if event.status == 'upcoming' %}
            <div class="countdown-timer" id="countdown">
                <h6 class="mb-3">Event Starts In</h6>
                <div id="countdown-display">
                    <div class="countdown-item">
                        <span class="countdown-number" id="days">00</span>
                        <span class="countdown-label">Days</span>
                    </div>
                    <div class="countdown-item">
                        <span class="countdown-number" id="hours">00</span>
                        <span class="countdown-label">Hours</span>
                    </div>
                    <div class="countdown-item">
                        <span class="countdown-number" id="minutes">00</span>
                        <span class="countdown-label">Minutes</span>
                    </div>
                    <div class="countdown-item">
                        <span class="countdown-number" id="seconds">00</span>
                        <span class="countdown-label">Seconds</span>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Registration Card -->
            <div class="register-card">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-plus me-2"></i>Event Registration
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if user.is_authenticated and user.user_type == '3' %}
                            {% if has_registered %}
                            <div class="alert alert-success mb-3">
                                <i class="fas fa-check-circle me-2"></i>
                                You are registered for this event!
                            </div>
                            <a href="{% url 'my_events' %}" class="btn btn-outline-primary w-100">
                                View My Events
                            </a>
                            {% elif event.is_registration_open %}
                                {% if event.max_attendees and event.eventregistration_set.count >= event.max_attendees %}
                                <div class="alert alert-warning mb-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    This event is fully booked.
                                </div>
                                <button class="btn btn-secondary w-100" disabled>
                                    Event Full
                                </button>
                                {% else %}
                                {% if not event.is_free and event.price %}
                                <div class="mb-3">
                                    <h5 class="text-center">Price: ${{ event.price }}</h5>
                                </div>
                                {% endif %}
                                <a href="{% url 'register_event' event.id %}" class="btn btn-primary w-100 btn-lg">
                                    <i class="fas fa-calendar-plus me-2"></i>Register Now
                                </a>
                                {% if event.requires_approval %}
                                <small class="text-muted d-block text-center mt-2">
                                    Registration requires approval
                                </small>
                                {% endif %}
                                {% endif %}
                            {% else %}
                            <div class="alert alert-warning mb-3">
                                <i class="fas fa-clock me-2"></i>
                                Registration is closed for this event.
                            </div>
                            {% endif %}
                        {% else %}
                        <p class="text-muted mb-3">Please log in as an alumni to register for this event.</p>
                        <a href="{% url 'login_page' %}" class="btn btn-primary w-100">
                            <i class="fas fa-sign-in-alt me-2"></i>Login to Register
                        </a>
                        <div class="text-center mt-2">
                            <small>
                                <a href="{% url 'alumni_registration' %}" class="text-decoration-none">
                                    Not registered? Join now
                                </a>
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Event Details -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Event Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="small">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Event ID:</span>
                                <span>#{{ event.id }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Duration:</span>
                                <span>
                                    {% if event.end_date and event.end_date != event.start_date %}
                                        {{ event.start_date|timesince:event.end_date }}
                                    {% elif event.end_time %}
                                        {% widthratio event.end_time.hour 1 1 %}{% widthratio event.end_time.minute 60 1 %} - {% widthratio event.start_time.hour 1 1 %}{% widthratio event.start_time.minute 60 1 %} hours
                                    {% else %}
                                        TBD
                                    {% endif %}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Registrations:</span>
                                <span>{{ event.eventregistration_set.count }}</span>
                            </div>
                            {% if event.contact_email %}
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Contact:</span>
                                <span>
                                    <a href="mailto:{{ event.contact_email }}" class="text-decoration-none">
                                        <i class="fas fa-envelope"></i>
                                    </a>
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Organizer Info -->
                <div class="card organizer-card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-user me-2"></i>Organizer</h5>
                    </div>
                    <div class="card-body text-center">
                        {% if event.organizer.admin.profile_pic %}
                        <img src="{{ event.organizer.admin.profile_pic.url }}" 
                             alt="{{ event.organizer.admin.get_full_name }}" 
                             class="rounded-circle mb-3" width="80" height="80">
                        {% else %}
                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 80px; height: 80px;">
                            <i class="fas fa-user fa-2x text-muted"></i>
                        </div>
                        {% endif %}
                        <h6>{{ event.organizer.admin.get_full_name }}</h6>
                        <p class="text-muted small mb-2">Alumni Coordinator</p>
                        {% if event.organizer.department %}
                        <p class="text-muted small">{{ event.organizer.department }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Share Event -->
                <div class="card mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-share-alt me-2"></i>Share Event</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button onclick="shareEvent('linkedin')" class="btn btn-outline-primary btn-sm">
                                <i class="fab fa-linkedin-in me-2"></i>LinkedIn
                            </button>
                            <button onclick="shareEvent('twitter')" class="btn btn-outline-info btn-sm">
                                <i class="fab fa-twitter me-2"></i>Twitter
                            </button>
                            <button onclick="shareEvent('facebook')" class="btn btn-outline-primary btn-sm">
                                <i class="fab fa-facebook-f me-2"></i>Facebook
                            </button>
                            <button onclick="copyEventLink()" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-link me-2"></i>Copy Link
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Similar Events -->
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-calendar me-2"></i>Similar Events</h5>
                    </div>
                    <div class="card-body">
                        <div class="small">
                            <a href="{% url 'public_events' %}?event_type={{ event.event_type }}" 
                               class="d-block text-decoration-none mb-2">
                                More {{ event.get_event_type_display }} events
                            </a>
                            <a href="{% url 'public_events' %}" 
                               class="d-block text-decoration-none mb-2">
                                All upcoming events
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Like and Comment Section -->
<div class="container my-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            {% include 'main_app/like_comment_section.html' %}
        </div>
    </div>
</div>

<!-- Navigation -->
<div class="bg-light py-4">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <a href="{% url 'public_events' %}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Events
                    </a>
                    <div class="text-center">
                        <small class="text-muted">{{ event.start_date|date:"F d, Y" }} at {{ event.start_time|time:"g:i A" }}</small>
                    </div>
                    <a href="{% url 'public_events' %}" class="btn btn-primary">
                        More Events <i class="fas fa-arrow-right ms-2"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Countdown Timer
{% if event.status == 'upcoming' %}
const eventDate = new Date('{{ event.start_date|date:"Y-m-d" }} {{ event.start_time|time:"H:i" }}').getTime();

function updateCountdown() {
    const now = new Date().getTime();
    const distance = eventDate - now;
    
    if (distance < 0) {
        document.getElementById('countdown').innerHTML = '<h6 class="mb-0">Event has started!</h6>';
        return;
    }
    
    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
    
    document.getElementById('days').textContent = days.toString().padStart(2, '0');
    document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
    document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
    document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
}

// Update countdown every second
setInterval(updateCountdown, 1000);
updateCountdown(); // Initial call
{% endif %}

function shareEvent(platform) {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent('{{ event.title|escapejs }} - {{ event.start_date|date:"M d, Y"|escapejs }}');
    
    let shareUrl;
    switch(platform) {
        case 'linkedin':
            shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
            break;
        case 'twitter':
            shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
            break;
        case 'facebook':
            shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
            break;
    }
    
    if (shareUrl) {
        window.open(shareUrl, '_blank', 'width=600,height=400');
    }
}

function copyEventLink() {
    navigator.clipboard.writeText(window.location.href).then(function() {
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');
        
        setTimeout(function() {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    });
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
